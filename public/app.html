<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/manifest.webmanifest">
  <title>Haven</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cG9seWdvbiBwb2ludHM9IjUwLDMgOTMsMjggOTMsNzIgNTAsOTcgNyw3MiA3LDI4IiBmaWxsPSJub25lIiBzdHJva2U9IiM2YjRmZGIiIHN0cm9rZS13aWR0aD0iOCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjx0ZXh0IHg9IjUwIiB5PSI2MyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsLEhlbHZldGljYSxzYW5zLXNlcmlmIiBmb250LXdlaWdodD0iYm9sZCIgZm9udC1zaXplPSIzOCIgZmlsbD0iIzZiNGZkYiIgb3BhY2l0eT0iMC45NSI+SDwvdGV4dD48L3N2Zz4=">
  <link rel="stylesheet" href="/css/style.css?v=1.8.0">
  <script src="/js/theme-init.js"></script>
</head>
<body>

  <div id="app">
    <div id="app-body">

      <!-- â”€â”€â”€ Server Bar (far left â€” like Discord) â”€â”€â”€â”€â”€â”€â”€ -->
      <nav class="server-bar" id="server-bar">
        <div class="server-icon home active" id="home-server" title="This Server">
          <span class="server-icon-text">â¬¡</span>
          <span class="server-status-dot online"></span>
        </div>
        <div class="server-separator"></div>
        <div id="server-list"></div>
        <button class="server-icon add-server" id="add-server-btn" title="Add Server">
          <span class="server-icon-text">+</span>
        </button>
        <button class="server-icon manage-servers" id="manage-servers-btn" title="Manage Servers">
          <span class="server-icon-text">âš™</span>
        </button>
      </nav>

      <!-- â”€â”€â”€ Left Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <aside class="sidebar">
        <div class="sidebar-resize-handle" id="sidebar-resize-handle"></div>
        <div class="sidebar-header">
          <div class="brand">
            <span class="logo-sm">â¬¡</span>
            <span class="brand-text">HAVEN</span>
          </div>
          <button id="mobile-sidebar-close" class="mobile-panel-close" title="Close" aria-label="Close sidebar">&times;</button>
          <div class="user-bar">
            <span class="led on" id="connection-led" title="Server connection"></span>
            <div class="user-names">
              <span class="current-user" id="current-user"></span>
              <span class="login-name" id="login-name" title="Your login username"></span>
            </div>
            <button id="rename-btn" class="icon-btn small" title="Change display name">âœï¸</button>
            <button id="logout-btn" class="icon-btn" title="Logout">â»</button>
          </div>
        </div>

        <div class="sidebar-mod-container" id="sidebar-mod-container">
          <div class="sidebar-section" data-mod-id="join">
            <h5 class="section-label">Join a Channel</h5>
            <div class="input-row">
              <input type="text" id="channel-code-input"
                     placeholder="Enter code..." maxlength="8" spellcheck="false">
              <button id="join-channel-btn" class="btn-sm">Join</button>
            </div>
          </div>

          <div class="sidebar-section" id="admin-controls" data-mod-id="create" style="display:none">
            <h5 class="section-label">Create Channel</h5>
            <div class="input-row">
              <input type="text" id="new-channel-name"
                     placeholder="Channel name..." maxlength="50">
              <button id="create-channel-btn" class="btn-sm btn-accent">+</button>
            </div>
          </div>

          <div class="sidebar-split" id="sidebar-split" data-mod-id="channels">
          <div class="sidebar-section channel-section" id="channels-pane">
            <h5 class="section-label channels-toggle" id="channels-toggle" style="cursor:pointer;user-select:none"><span class="channels-toggle-arrow" id="channels-toggle-arrow">â–¾</span><span class="section-label-text" style="flex:1">Channels</span><button class="icon-btn small admin-only" id="organize-channels-btn" title="Organize channels" style="display:none;font-size:0.85rem;padding:2px 6px;opacity:0.6;position:relative;z-index:2">ğŸ“‹</button></h5>
            <div class="channel-list" id="channel-list"></div>
          </div>
          <div class="sidebar-split-handle" id="sidebar-split-handle" title="Drag to resize"></div>
          <div class="sidebar-section dm-section-pane" id="dm-pane">
            <h5 class="section-label dm-section-label dm-toggle" id="dm-toggle-header" style="cursor:pointer;user-select:none"><span class="dm-toggle-arrow" id="dm-toggle-arrow">â–¾</span><span class="section-label-text" style="flex:1">Direct Messages</span><span style="display:flex;align-items:center;gap:4px;position:relative;z-index:2"><span class="dm-unread-count" id="dm-unread-badge" style="display:none"></span><button class="icon-btn small" id="organize-dms-btn" title="Organize DMs" style="font-size:0.85rem;padding:2px 6px;opacity:0.6">ğŸ“‹</button></span></h5>
            <div class="dm-list-scroll" id="dm-list"></div>
          </div>
        </div>
        </div>

        <!-- Pinned bottom area (never pushed off screen) -->
        <div class="sidebar-bottom">
          <!-- Theme popup (floats above bottom bar) -->
          <div id="theme-popup" class="theme-popup" style="display:none">
            <div class="theme-popup-header">
              <span class="theme-popup-title">Theme</span>
              <button id="theme-popup-close" class="icon-btn small" title="Close">&times;</button>
            </div>
            <div class="theme-selector" id="theme-selector">
              <button class="theme-btn active" data-theme="haven" title="Haven"><span class="theme-icon">â¬¡</span></button>
              <button class="theme-btn" data-theme="discord" title="Discord"><span class="theme-icon">ğŸ®</span></button>
              <button class="theme-btn" data-theme="matrix" title="Matrix"><span class="theme-icon">â…¯</span></button>
              <button class="theme-btn" data-theme="tron" title="Tron"><span class="theme-icon">â—ˆ</span></button>
              <button class="theme-btn" data-theme="halo" title="HALO"><span class="theme-icon">âŒ</span></button>
              <button class="theme-btn" data-theme="lotr" title="LoTR"><span class="theme-icon">âšœ</span></button>
              <button class="theme-btn" data-theme="cyberpunk" title="Cyberpunk"><span class="theme-icon">âš¡</span></button>
              <button class="theme-btn" data-theme="nord" title="Nord"><span class="theme-icon">â„</span></button>
              <button class="theme-btn" data-theme="dracula" title="Dracula"><span class="theme-icon">ğŸ§›</span></button>
              <button class="theme-btn" data-theme="bloodborne" title="Bloodborne"><span class="theme-icon">ğŸ©¸</span></button>
              <button class="theme-btn" data-theme="darksouls" title="Dark Souls"><span class="theme-icon">ğŸ”¥</span></button>
              <button class="theme-btn" data-theme="eldenring" title="Elden Ring"><span class="theme-icon">ğŸ’</span></button>
              <button class="theme-btn" data-theme="ice" title="Ice"><span class="theme-icon">ğŸ§Š</span></button>
              <button class="theme-btn" data-theme="abyss" title="Abyss"><span class="theme-icon">ğŸŒŠ</span></button>
              <button class="theme-btn" data-theme="minecraft" title="Minecraft"><span class="theme-icon">â›ï¸</span></button>
              <button class="theme-btn" data-theme="ffx" title="Final Fantasy X"><span class="theme-icon">âš”ï¸</span></button>
              <button class="theme-btn" data-theme="zelda" title="Zelda"><span class="theme-icon">ğŸ—¡ï¸</span></button>
              <button class="theme-btn" data-theme="fallout" title="Fallout (PIP Boy)"><span class="theme-icon">â˜¢ï¸</span></button>
              <button class="theme-btn" data-theme="scripture" title="Scripture"><span class="theme-icon">âœï¸</span></button>
              <button class="theme-btn" data-theme="chapel" title="Chapel"><span class="theme-icon">â›ª</span></button>
              <button class="theme-btn" data-theme="gospel" title="Gospel"><span class="theme-icon">ğŸ•Šï¸</span></button>
              <button class="theme-btn" data-theme="crt" title="CRT"><span class="theme-icon">ğŸ“º</span></button>
              <button class="theme-btn" data-theme="win95" title="Windows 95"><span class="theme-icon">ğŸªŸ</span></button>
              <button class="theme-btn" data-theme="custom" title="Custom"><span class="theme-icon" id="custom-theme-swatch">ğŸ¨</span></button>
              <button class="theme-btn" data-theme="rgb" title="RGB"><span class="theme-icon">ğŸŒˆ</span></button>
            </div>
            <!-- Effect overlay picker (mashup) -->
            <div class="effect-overlay-section">
              <div class="theme-popup-title" style="margin-top: 2px;">Effect Overlay</div>
              <div class="effect-selector" id="effect-selector">
                <button class="effect-btn active" data-effect="auto" title="Match theme">âŸ³</button>
                <button class="effect-btn" data-effect="none" title="No effects">ğŸš«</button>
                <button class="effect-btn" data-effect="crt" title="CRT Scanlines">ğŸ“º</button>
                <button class="effect-btn" data-effect="matrix" title="Matrix Rain">â…¯</button>
                <button class="effect-btn" data-effect="matrixbars" title="Matrix Scan Lines">â–¤</button>
                <button class="effect-btn" data-effect="nord" title="Snowfall">â„</button>
                <button class="effect-btn" data-effect="darksouls" title="Campfire">ğŸ”¥</button>
                <button class="effect-btn" data-effect="eldenring" title="Golden Grace">ğŸ’</button>
                <button class="effect-btn" data-effect="bloodborne" title="Blood Vignette">ğŸ©¸</button>
                <button class="effect-btn" data-effect="fallout" title="Phosphor Glow">â˜¢ï¸</button>
                <button class="effect-btn" data-effect="ffx" title="Water Flow">âš”ï¸</button>
                <button class="effect-btn" data-effect="ice" title="Frost Shimmer">ğŸ§Š</button>
                <button class="effect-btn" data-effect="cyberpunk" title="Glitch">âš¡</button>
                <button class="effect-btn" data-effect="lotr" title="Candlelight">âšœ</button>
                <button class="effect-btn" data-effect="abyss" title="Ocean Depth">ğŸŒŠ</button>
                <button class="effect-btn" data-effect="scripture" title="Cross Light">âœï¸</button>
                <button class="effect-btn" data-effect="chapel" title="Stained Glass">â›ª</button>
                <button class="effect-btn" data-effect="gospel" title="Divine Radiance">ğŸ•Šï¸</button>
              </div>
            </div>
            <!-- Custom theme triangle picker -->
            <div id="custom-theme-editor" style="display:none">
              <canvas id="custom-hue-bar" width="206" height="18"></canvas>
              <canvas id="custom-triangle" width="206" height="180"></canvas>
            </div>
            <!-- RGB theme controls -->
            <div id="rgb-theme-editor" class="rgb-theme-editor" style="display:none">
              <label class="rgb-slider-row">
                <span class="rgb-slider-label">Speed</span>
                <input type="range" id="rgb-speed-slider" min="1" max="100" value="30" class="slider-sm rgb-slider">
              </label>
              <label class="rgb-slider-row">
                <span class="rgb-slider-label">Vibrancy</span>
                <input type="range" id="rgb-vibrancy-slider" min="10" max="100" value="75" class="slider-sm rgb-slider">
              </label>
            </div>
            <!-- Effect speed slider (dynamic-effect themes) -->
            <div id="effect-speed-editor" class="rgb-theme-editor" style="display:none">
              <label class="rgb-slider-row">
                <span class="rgb-slider-label">Effect Speed</span>
                <input type="range" id="effect-speed-slider" min="15" max="200" value="100" class="slider-sm rgb-slider">
              </label>
            </div>
            <!-- Sacred intensity slider (religious themes) -->
            <div id="sacred-intensity-editor" class="rgb-theme-editor" style="display:none">
              <label class="rgb-slider-row">
                <span class="rgb-slider-label">Sacred Intensity</span>
                <input type="range" id="sacred-intensity-slider" min="20" max="250" value="100" class="slider-sm rgb-slider">
              </label>
            </div>
            <!-- Glitch frequency slider (cyberpunk) -->
            <div id="glitch-freq-editor" class="rgb-theme-editor" style="display:none">
              <label class="rgb-slider-row">
                <span class="rgb-slider-label">Glitch Frequency</span>
                <input type="range" id="glitch-freq-slider" min="5" max="100" value="50" class="slider-sm rgb-slider">
              </label>
            </div>
            <!-- CRT effect sliders (vignette darkness + scanline intensity) -->
            <div id="crt-editor" class="rgb-theme-editor" style="display:none">
              <label class="rgb-slider-row">
                <span class="rgb-slider-label">CRT Vignette</span>
                <input type="range" id="crt-vignette-slider" min="0" max="100" value="50" class="slider-sm rgb-slider">
              </label>
              <label class="rgb-slider-row">
                <span class="rgb-slider-label">CRT Scanlines</span>
                <input type="range" id="crt-scanline-slider" min="0" max="80" value="45" class="slider-sm rgb-slider">
              </label>
            </div>
          </div>

          <!-- Bottom bar -->
          <div class="sidebar-bottom-bar">
            <button id="theme-popup-toggle" class="sidebar-bottom-btn" title="Themes">ğŸ¨</button>
            <button class="sidebar-bottom-btn" id="activities-btn" title="Activities">ğŸ®</button>
            <button id="mobile-settings-btn" class="sidebar-bottom-btn mobile-settings-btn" title="Settings">âš™ï¸</button>
            <div id="voice-bar" class="voice-bar" style="display:none"></div>
            <span style="flex:1"></span>
            <a href="https://ko-fi.com/ancsemi" target="_blank" rel="noopener noreferrer" class="sidebar-bottom-btn donate-btn" title="Support Haven">â¤ï¸</a>
          </div>
        </div>
      </aside>

      <!-- â”€â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <main class="main">
        <header class="channel-header">
          <button id="mobile-menu-btn" class="mobile-menu-btn" title="Menu" aria-label="Menu">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
              <line x1="3" y1="6" x2="21" y2="6"/>
              <line x1="3" y1="12" x2="21" y2="12"/>
              <line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
          </button>
          <div class="channel-info">
            <h3 id="channel-header-name">Select a channel</h3>
          </div>
          <div class="header-actions-box" id="header-actions-box" style="display:none">
            <span class="channel-code-tag" id="channel-code-display" title="Channel code"></span>
            <button id="copy-code-btn" class="icon-btn small" title="Copy code">ğŸ“‹</button>
            <button id="channel-code-settings-btn" class="icon-btn small" title="Channel code settings">âš™ï¸</button>
            <span class="header-actions-divider"></span>
            <button id="search-toggle-btn" class="icon-btn small" title="Search messages (Ctrl+F)">ğŸ”</button>
            <button id="pinned-toggle-btn" class="icon-btn small" title="Pinned messages">ğŸ“Œ</button>
            <div class="e2e-menu-wrapper" style="display:none" id="e2e-menu-wrapper">
              <button id="e2e-menu-btn" class="icon-btn small" title="Encryption options">ğŸ”</button>
              <div class="e2e-dropdown" id="e2e-dropdown" style="display:none">
                <button class="e2e-dropdown-item" id="e2e-verify-btn">ğŸ”‘ Verify Encryption</button>
                <button class="e2e-dropdown-item e2e-danger" id="e2e-reset-btn">ğŸ”„ Reset Encryption Keys</button>
              </div>
            </div>
          </div>
          <div class="search-container" id="search-container" style="display:none">
            <input type="text" id="search-input" class="search-input" placeholder="Search messages..." maxlength="100">
            <button id="search-close-btn" class="icon-btn small" title="Close search">&times;</button>
          </div>
          <!-- Update available banner -->
          <a id="update-banner" class="update-banner" href="#" style="display:none" target="_blank" rel="noopener">
            <span class="update-pulse"></span>
            <span class="update-text">Update Available</span>
          </a>
          <!-- Spacer pushes voice controls to the right -->
          <div style="flex:1"></div>
          <!-- Right-side: dynamic indicators, then voice (always furthest right) -->
          <div class="voice-controls">
            <button id="mobile-users-btn" class="mobile-users-btn" title="Members" aria-label="Members">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
            </button>
            <!-- Dynamic indicators (music, streams) inject here via JS -->
            <button id="voice-join-btn" class="btn-voice" style="display:none">
              ğŸ¤ Join Voice
            </button>
            <div id="voice-active-indicator" class="voice-active-indicator" style="display:none">
              <span class="voice-indicator-icon">ğŸ¤</span>
              <span class="voice-indicator-text">Voice Active</span>
            </div>
          </div>
        </header>

        <!-- Welcome Screen -->
        <div id="no-channel-msg" class="welcome-screen">
          <div class="welcome-content">
            <div class="welcome-icon">â¬¡</div>
            <h2>Welcome to Haven</h2>
            <p>Join a channel with a code from your friends,<br>
               or create one if you're the admin.</p>
          </div>
        </div>

        <!-- Chat Area -->
        <div id="message-area" class="message-area" style="display:none">
          <!-- Screen Share Viewer (multi-stream) -->
          <div id="screen-share-container" class="screen-share-container" style="display:none">
            <div class="screen-share-header">
              <span id="screen-share-label">ğŸ–¥ï¸ Streams</span>
              <div class="screen-share-header-controls">
                <label class="stream-size-label" title="Stream display size">
                  ğŸ–¥ï¸
                  <input type="range" id="stream-size-slider" class="stream-size-slider" min="20" max="90" value="50">
                </label>
                <button id="screen-share-minimize" class="icon-btn small" title="Minimize streams">â”€</button>
                <button id="screen-share-close" class="icon-btn small" title="Close streams">âœ•</button>
              </div>
            </div>
            <div id="screen-share-grid" class="screen-share-grid"></div>
          </div>
          <!-- Music Player Panel -->
          <div id="music-panel" class="music-panel" style="display:none">
            <div class="music-panel-header">
              <div class="music-panel-header-left">
                <button id="music-popout-btn" class="icon-btn small" title="Pop out player">â§‰</button>
                <span id="music-panel-label">ğŸµ Listening Together</span>
              </div>
              <div class="music-panel-controls">
                <button id="music-prev-btn" class="icon-btn small" title="Previous track" style="display:none">â®</button>
                <button id="music-play-pause-btn" class="icon-btn small" title="Play/Pause">â¸</button>
                <button id="music-next-btn" class="icon-btn small" title="Next track" style="display:none">â­</button>
                <button id="music-shuffle-btn" class="icon-btn small" title="Shuffle" style="display:none">ğŸ”€</button>
                <span id="music-time-current" class="music-time">0:00</span>
                <input type="range" id="music-seek-slider" class="music-seek-slider" min="0" max="100" value="0" step="0.1" title="Seek">
                <span id="music-time-duration" class="music-time">0:00</span>
                <button id="music-mute-btn" class="icon-btn small" title="Mute music">ğŸ”Š</button>
                <input type="range" id="music-volume-slider" class="stream-vol-slider" min="0" max="100" value="80" title="Music volume">
                <button id="music-close-btn" class="icon-btn small" title="Minimize">â”€</button>
                <button id="music-stop-btn" class="icon-btn small" title="Close / stop music">âœ•</button>
              </div>
            </div>
            <div id="music-embed-container" class="music-embed-container"></div>
          </div>
          <div id="search-results-panel" class="search-results-panel" style="display:none">
            <div class="search-results-header">
              <span id="search-results-count">Results</span>
              <button id="search-results-close" class="icon-btn small">&times;</button>
            </div>
            <div id="search-results-list" class="search-results-list"></div>
          </div>
          <div id="pinned-panel" class="pinned-panel" style="display:none">
            <div class="pinned-panel-header">
              <span id="pinned-count">ğŸ“Œ Pinned Messages</span>
              <button id="pinned-close" class="icon-btn small">&times;</button>
            </div>
            <div id="pinned-list" class="pinned-list"></div>
          </div>
          <div class="messages" id="messages"></div>
          <div class="typing-indicator" id="typing-indicator"></div>
          <div id="reply-bar" class="reply-bar" style="display:none">
            <span class="reply-bar-text" id="reply-preview-text"></span>
            <button class="reply-bar-close" id="reply-close-btn" title="Cancel reply">&times;</button>
          </div>
          <div id="image-queue-bar" class="image-queue-bar" style="display:none"></div>
          <div class="message-input-area">
            <div class="input-actions-box">
              <button id="upload-btn" class="btn-upload" title="Upload File">
                <svg class="upload-icon-default" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <path d="M21 15l-5-5L5 21"/>
                </svg>
                <span class="upload-icon-clippy">ğŸ“</span>
              </button>
              <span class="input-actions-divider"></span>
              <button id="emoji-btn" class="btn-emoji" title="Emoji">ğŸ˜€</button>
              <span class="input-actions-divider"></span>
              <button id="gif-btn" class="btn-gif" title="Search GIFs">GIF</button>
            </div>
            <div id="emoji-picker" class="emoji-picker" style="display:none"></div>
            <div id="gif-picker" class="gif-picker" style="display:none">
              <div class="gif-picker-header">
                <input type="text" id="gif-search-input" placeholder="Search GIPHY..." maxlength="100" autocomplete="off">
              </div>
              <div class="gif-picker-grid" id="gif-grid"></div>
              <div class="gif-picker-footer">Powered by GIPHY</div>
            </div>
            <div id="mention-dropdown" class="mention-dropdown" style="display:none"></div>
            <div id="emoji-dropdown" class="emoji-dropdown" style="display:none"></div>
            <div id="slash-dropdown" class="slash-dropdown" style="display:none"></div>
            <textarea id="message-input" placeholder="Type a message... (/ for commands)"
                      rows="1" maxlength="2000"></textarea>
            <button id="send-btn" class="btn-send" title="Send">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
          <input type="file" id="file-input" style="display:none">
        </div>
      </main>

      <!-- â”€â”€â”€ Right Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <aside class="right-sidebar" id="right-sidebar">
        <div class="right-sidebar-resize-handle" id="right-sidebar-resize-handle"></div>
        <button id="mobile-right-close" class="mobile-panel-close mobile-panel-close-right" title="Close" aria-label="Close panel">&times;</button>
        <!-- Voice users section (top) -->
        <div class="right-sidebar-voice" id="right-sidebar-voice">
          <div class="panel">
            <h5 class="panel-title">ğŸ”Š Voice</h5>
            <button id="voice-join-mobile" class="btn-voice mobile-voice-join" style="display:none">ğŸ¤ Join Voice</button>
            <div id="voice-users" class="user-list">
              <p class="muted-text">No one in voice</p>
            </div>
          </div>
        </div>
        <!-- Scrollable users section -->
        <div class="right-sidebar-users" id="right-sidebar-users">
          <div class="panel">
            <h5 class="panel-title">ğŸ‘¥ Online</h5>
            <div id="online-users" class="user-list">
              <p class="muted-text">Select a channel</p>
            </div>
          </div>
        </div>
        <!-- Voice settings sub-panel (slides up above controls) -->
        <div id="voice-settings-panel" class="voice-settings-panel" style="display:none">
          <div class="voice-settings-row">
            <label class="voice-settings-label">ğŸ¤« Noise Suppression</label>
            <input type="range" id="voice-ns-slider" class="ns-slider" min="0" max="100" value="10" title="Noise gate: 0 = off, 100 = aggressive">
          </div>
        </div>
        <!-- Voice controls bar (pinned above settings) -->
        <div id="voice-panel" class="voice-panel" style="display:none">
          <button id="voice-mute-btn" class="voice-panel-btn" title="Mute">ğŸ™ï¸</button>
          <button id="voice-deafen-btn" class="voice-panel-btn" title="Deafen">ğŸ”Š</button>
          <button id="screen-share-btn" class="voice-panel-btn" title="Share Screen">ğŸ–¥ï¸</button>
          <button id="music-share-btn" class="voice-panel-btn" title="Listen Together">ğŸµ</button>
          <button id="voice-settings-toggle" class="voice-panel-btn" title="Voice Settings">âš™ï¸</button>
          <span class="voice-panel-divider"></span>
          <button id="voice-leave-sidebar-btn" class="voice-panel-btn voice-panel-leave" title="Leave Voice">âœ•</button>
        </div>
        <!-- Settings button pinned at bottom -->
        <div class="panel sidebar-settings-panel">
          <button class="btn-settings-popout" id="open-settings-btn" title="Settings">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            <span>Settings</span>
          </button>
        </div>
      </aside>

      <!-- Mobile overlay (click to close sidebars) -->
      <div id="mobile-overlay" class="mobile-overlay"></div>
    </div>

    <!-- â”€â”€â”€ Status Bar (bottom) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="status-bar" id="status-bar">
      <div class="status-item">
        <span class="led on" id="status-server-led"></span>
        <span class="label">Server</span>
        <span class="value" id="status-server-text">Connected</span>
      </div>
      <div class="divider"></div>
      <div class="status-item">
        <span class="led off" id="status-voice-led"></span>
        <span class="label">Voice</span>
        <span class="value" id="status-voice-text">Off</span>
      </div>
      <div class="divider"></div>
      <div class="status-item">
        <span class="label">Ping</span>
        <span class="value" id="status-ping">--</span>
        <span class="label">ms</span>
      </div>
      <div class="divider"></div>
      <div class="status-item">
        <span class="label">Channel</span>
        <span class="value" id="status-channel">None</span>
      </div>
      <div class="divider"></div>
      <div class="status-item status-online-trigger" id="status-online-trigger" title="Click to see who's online">
        <span class="label">Online</span>
        <span class="value" id="status-online-count">0</span>
      </div>
      <span class="spacer"></span>
      <div class="status-item">
        <span class="value" id="status-clock"></span>
      </div>
      <div class="divider"></div>
      <div class="status-item">
        <span class="value" id="status-version"></span>
      </div>
    </div>

    <!-- Online users overlay (floats above status bar) -->
    <div id="online-overlay" class="online-overlay" style="display:none">
      <div class="online-overlay-header">
        <span class="online-overlay-title">Users</span>
        <button id="online-overlay-close" class="icon-btn small" title="Close">&times;</button>
      </div>
      <div id="online-overlay-list" class="online-overlay-list"></div>
    </div>
  </div>

  <!-- Hidden audio container for voice streams -->
  <div id="audio-container" style="display:none"></div>

  <!-- Toast notifications -->
  <div id="toast-container"></div>

  <!-- First-Time Setup Wizard (Admin only) -->
  <div class="modal-overlay" id="setup-wizard-modal" style="display:none">
    <div class="modal modal-wizard">
      <div class="wizard-header">
        <span class="wizard-hex">â¬¡</span>
        <h2>Welcome to Haven</h2>
        <p class="wizard-subtitle">Let's get your server ready. This only takes a minute.</p>
      </div>

      <div class="wizard-steps">
        <!-- Step indicators -->
        <div class="wizard-step-indicators">
          <div class="wizard-indicator active" data-step="1">1</div>
          <div class="wizard-indicator-line"></div>
          <div class="wizard-indicator" data-step="2">2</div>
          <div class="wizard-indicator-line"></div>
          <div class="wizard-indicator" data-step="3">3</div>
          <div class="wizard-indicator-line"></div>
          <div class="wizard-indicator" data-step="4">4</div>
        </div>

        <!-- Step 1: Server basics -->
        <div class="wizard-step" id="wizard-step-1" style="display:block">
          <h3>ğŸ  Your Server</h3>
          <p>Everything is already running. Here's what was set up automatically:</p>
          <div class="wizard-checklist">
            <div class="wizard-check">âœ… SSL certificates generated (encrypted connections)</div>
            <div class="wizard-check">âœ… Database created</div>
            <div class="wizard-check">âœ… Security keys generated</div>
            <div class="wizard-check">âœ… Admin account created (that's you!)</div>
          </div>
          <div class="wizard-info-box">
            <strong>Your server name:</strong>
            <input type="text" id="wizard-server-name" class="wizard-input" value="Haven" placeholder="e.g. My Server, The Hideout">
            <span class="wizard-hint">This is what your friends see in their server list.</span>
          </div>
        </div>

        <!-- Step 2: Create first channel -->
        <div class="wizard-step" id="wizard-step-2" style="display:none">
          <h3>ğŸ“¢ Create Your First Channel</h3>
          <p>Channels are where conversations happen. Create one to get started.</p>
          <div class="wizard-info-box">
            <strong>Channel name:</strong>
            <input type="text" id="wizard-channel-name" class="wizard-input" value="General" placeholder="e.g. General, Gaming, Hangout">
            <span class="wizard-hint">You can create more channels later from the sidebar.</span>
          </div>
          <div id="wizard-channel-result" style="display:none">
            <div class="wizard-check" id="wizard-channel-created">âœ… Channel created!</div>
            <div class="wizard-code-display">
              <span>Invite code:</span>
              <code id="wizard-channel-code"></code>
              <button id="wizard-copy-code" class="wizard-btn-small">Copy</button>
            </div>
            <span class="wizard-hint">Share this code with friends so they can join this channel.</span>
          </div>
        </div>

        <!-- Step 3: Connectivity check -->
        <div class="wizard-step" id="wizard-step-3" style="display:none">
          <h3>ğŸŒ Internet Access</h3>
          <p>Want friends outside your WiFi to connect? Let's check if your server is reachable from the internet.</p>
          <div id="wizard-port-checking" style="display:none">
            <div class="wizard-spinner"></div>
            <span>Checking port reachability...</span>
          </div>
          <div id="wizard-port-result" style="display:none"></div>
          <button id="wizard-check-port-btn" class="wizard-btn-secondary">ğŸ” Check My Connection</button>
          <div class="wizard-info-box" style="margin-top:16px">
            <span class="wizard-hint"><strong>LAN only?</strong> If your friends are on the same WiFi, you can skip this â€” it will work automatically.</span>
          </div>
        </div>

        <!-- Step 4: You're ready -->
        <div class="wizard-step" id="wizard-step-4" style="display:none">
          <h3>ğŸ‰ You're All Set!</h3>
          <p>Haven is running and ready for your friends.</p>
          <div class="wizard-checklist">
            <div class="wizard-check">âœ… Server configured</div>
            <div class="wizard-check" id="wizard-summary-channel">âœ… First channel created</div>
            <div class="wizard-check" id="wizard-summary-port">â­ï¸ Port check skipped</div>
          </div>
          <div class="wizard-info-box">
            <strong>How friends join:</strong>
            <ol class="wizard-steps-list">
              <li>They open <code id="wizard-final-url">https://YOUR_IP:3000</code> in their browser</li>
              <li>Click "Advanced" â†’ "Proceed" on the certificate warning</li>
              <li>Register a username and password</li>
              <li>Enter the channel invite code you share with them</li>
            </ol>
          </div>
          <div class="wizard-info-box">
            <span class="wizard-hint">ğŸ’¡ <strong>Tip:</strong> You can always access settings with the âš™ï¸ gear icon in the sidebar. This wizard won't show again.</span>
          </div>
        </div>
      </div>

      <div class="wizard-footer">
        <button id="wizard-back-btn" class="wizard-btn-secondary" style="display:none">â† Back</button>
        <div style="flex:1"></div>
        <button id="wizard-skip-btn" class="wizard-btn-text">Skip Setup</button>
        <button id="wizard-next-btn" class="wizard-btn-primary">Next â†’</button>
      </div>
    </div>
  </div>

  <!-- Channel Code Settings Modal (Admin) -->
  <div class="modal-overlay" id="code-settings-modal" style="display:none">
    <div class="modal">
      <h3>Channel Code Settings</h3>
      <p class="modal-desc" id="code-settings-channel-name"></p>
      <div class="form-group">
        <label>Code Visibility</label>
        <select id="code-visibility-select" class="form-select">
          <option value="public">Public â€” everyone can see the code</option>
          <option value="private">Private â€” only admins see the code</option>
        </select>
      </div>
      <div class="form-group">
        <label>Code Mode</label>
        <select id="code-mode-select" class="form-select">
          <option value="static">Static â€” code never changes</option>
          <option value="dynamic">Dynamic â€” code rotates automatically</option>
        </select>
      </div>
      <div class="form-group" id="rotation-type-group" style="display:none">
        <label>Rotation Trigger</label>
        <select id="code-rotation-type-select" class="form-select">
          <option value="time">Time-based â€” rotate every X minutes</option>
          <option value="joins">Join-based â€” rotate after X new joins</option>
        </select>
      </div>
      <div class="form-group" id="rotation-interval-group" style="display:none">
        <label id="rotation-interval-label">Rotation Interval (minutes)</label>
        <input type="number" id="code-rotation-interval" min="1" max="10000" value="60">
      </div>
      <div class="modal-actions">
        <button class="btn-sm" id="code-settings-cancel-btn">Cancel</button>
        <button class="btn-sm btn-accent" id="code-rotate-now-btn">ğŸ”„ Rotate Now</button>
        <button class="btn-sm btn-accent" id="code-settings-save-btn">Save</button>
      </div>
    </div>
  </div>

  <!-- Add Server Modal -->
  <div class="modal-overlay" id="add-server-modal" style="display:none">
    <div class="modal">
      <h3 id="add-server-modal-title">Add a Server</h3>
      <p class="modal-desc">Connect to a friend's Haven server</p>
      <div class="form-group">
        <label>Server Name</label>
        <input type="text" id="add-server-name-input" placeholder='e.g. Jake&apos;s Haven' maxlength="30">
      </div>
      <div class="form-group">
        <label>Server Address</label>
        <input type="text" id="server-url-input" placeholder="e.g. https://192.168.1.5:3000">
      </div>
      <div class="form-group">
        <label>Icon URL <span class="muted-text">(optional)</span></label>
        <input type="text" id="add-server-icon-input" placeholder="https://... or leave blank">
      </div>
      <label class="eula-check-row" style="margin-bottom:12px;gap:8px">
        <input type="checkbox" id="server-auto-icon" checked>
        <span>Auto-pull icon from server</span>
      </label>
      <div class="modal-actions">
        <button class="btn-sm" id="cancel-server-btn">Cancel</button>
        <button class="btn-sm btn-accent" id="save-server-btn">Add Server</button>
      </div>
    </div>
  </div>

  <!-- Rename / Profile Modal -->
  <div class="modal-overlay" id="rename-modal" style="display:none">
    <div class="modal">
      <h3>Edit Profile</h3>

      <!-- Avatar Customizer -->
      <div class="avatar-settings" style="margin-bottom: 16px;">
        <h5 class="settings-section-subtitle">Avatar</h5>
        <div class="avatar-upload-row" style="margin-bottom: 10px;">
          <div class="avatar-upload-preview" id="avatar-upload-preview"></div>
          <button type="button" class="btn-sm" id="avatar-upload-btn">Upload</button>
          <button type="button" class="btn-sm" id="avatar-remove-btn">Clear</button>
          <input type="file" id="avatar-file-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display:none">
        </div>
        <small class="muted-text" style="display:block;margin-top:-4px;margin-bottom:8px;opacity:0.6">JPG, PNG, GIF (animated!), WebP Â· Max 2 MB</small>
        <h5 class="settings-section-subtitle">Shape</h5>
        <div class="avatar-shape-picker" id="avatar-shape-picker">
          <button type="button" class="avatar-shape-btn active" data-shape="circle" title="Circle"><div class="shape-preview shape-circle"></div></button>
          <button type="button" class="avatar-shape-btn" data-shape="rounded" title="Rounded"><div class="shape-preview shape-rounded"></div></button>
          <button type="button" class="avatar-shape-btn" data-shape="squircle" title="Squircle"><div class="shape-preview shape-squircle"></div></button>
          <button type="button" class="avatar-shape-btn" data-shape="hex" title="Hexagon"><div class="shape-preview shape-hex"></div></button>
          <button type="button" class="avatar-shape-btn" data-shape="diamond" title="Diamond"><div class="shape-preview shape-diamond"></div></button>
        </div>
      </div>

      <!-- Display Name -->
      <p class="modal-desc">Letters, numbers, underscores, and spaces (2â€“20 chars)</p>
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" id="rename-input" placeholder="New display name..." maxlength="20">
      </div>

      <!-- Bio -->
      <div class="form-group" style="margin-top:8px">
        <label>Bio <span class="muted-text">(max 190 chars)</span></label>
        <textarea id="edit-profile-bio" class="edit-profile-textarea" maxlength="190" placeholder="Tell people about yourselfâ€¦" rows="2"></textarea>
      </div>

      <div class="modal-actions">
        <span id="avatar-save-status" class="settings-hint" style="flex:1"></span>
        <button class="btn-sm" id="cancel-rename-btn">Cancel</button>
        <button class="btn-sm btn-accent" id="save-rename-btn">Save</button>
      </div>
    </div>
  </div>

  <!-- Admin Action Modal (Kick/Ban/Mute) -->
  <div class="modal-overlay" id="admin-action-modal" style="display:none">
    <div class="modal">
      <h3 id="admin-action-title">Moderate User</h3>
      <p class="modal-desc" id="admin-action-desc"></p>
      <div class="form-group" id="admin-reason-group">
        <label>Reason (optional)</label>
        <input type="text" id="admin-action-reason" placeholder="Reason..." maxlength="200">
      </div>
      <div class="form-group" id="admin-duration-group" style="display:none">
        <label>Duration (minutes)</label>
        <input type="number" id="admin-action-duration" value="10" min="1" max="43200" step="1">
      </div>
      <div class="modal-actions">
        <button class="btn-sm" id="cancel-admin-action-btn">Cancel</button>
        <button class="btn-sm btn-accent btn-danger-fill" id="confirm-admin-action-btn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Settings Popout Modal -->
  <div class="modal-overlay" id="settings-modal" style="display:none">
    <div class="modal modal-settings">
      <div class="settings-header">
        <h3>âš™ï¸ Settings</h3>
        <button class="settings-close-btn" id="close-settings-btn">&times;</button>
      </div>

      <div class="settings-layout">
        <nav class="settings-nav" id="settings-nav">
          <div class="settings-nav-group">User</div>
          <div class="settings-nav-item active" data-target="section-density">ğŸ“ Layout</div>
          <div class="settings-nav-item" data-target="section-sounds">ğŸ”” Sounds</div>
          <div class="settings-nav-item" data-target="section-push">ğŸ“² Push</div>
          <div class="settings-nav-item" data-target="section-password">ğŸ”’ Password</div>
          <div class="settings-nav-group settings-nav-admin" style="display:none">Admin</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-branding" style="display:none">ğŸ  Branding</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-members" style="display:none">ğŸ‘¥ Members</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-whitelist" style="display:none">ğŸ›¡ï¸ Whitelist</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-invite" style="display:none">ğŸŒ Invite Code</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-cleanup" style="display:none">ğŸ—‘ï¸ Cleanup</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-uploads" style="display:none">ğŸ“ Uploads</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-sounds-admin" style="display:none">ğŸ”Š Sounds</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-emojis" style="display:none">ğŸ˜ Emojis</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-roles" style="display:none">ğŸ‘‘ Roles</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-tunnel" style="display:none">ğŸ§­ Tunnel</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-bots" style="display:none">ğŸ¤– Bots</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-import" style="display:none">ğŸ“¦ Import</div>
          <div class="settings-nav-item settings-nav-admin" data-target="section-modmode" style="display:none">ğŸ”§ Mod Mode</div>
        </nav>
        <div class="settings-body">

      <!-- Layout Density Section -->
      <div class="settings-section" id="section-density">
        <h5 class="settings-section-title">ğŸ“ Layout Density</h5>
        <div class="density-picker" id="density-picker">
          <button type="button" class="density-btn" data-density="compact" title="Compact â€” tighter spacing, smaller avatars">
            <span class="density-icon">â–ªï¸</span>
            <span class="density-label">Compact</span>
          </button>
          <button type="button" class="density-btn active" data-density="cozy" title="Cozy â€” default balanced layout">
            <span class="density-icon">â—¾</span>
            <span class="density-label">Cozy</span>
          </button>
          <button type="button" class="density-btn" data-density="spacious" title="Spacious â€” more breathing room">
            <span class="density-icon">â¬›</span>
            <span class="density-label">Spacious</span>
          </button>
        </div>
      </div>

      <!-- Image Display Mode -->
      <div class="settings-section" id="section-density" style="border-top: 1px solid var(--border-light); padding-top: 16px; margin-top: 8px;">
        <h5 class="settings-section-title">ğŸ–¼ï¸ Image Display</h5>
        <div class="density-picker" id="image-mode-picker">
          <button type="button" class="density-btn active" data-image-mode="thumbnail" title="Thumbnail â€” small preview, click to enlarge">
            <span class="density-icon">ğŸ”</span>
            <span class="density-label">Thumbnail</span>
          </button>
          <button type="button" class="density-btn" data-image-mode="full" title="Full â€” large inline images like Discord">
            <span class="density-icon">ğŸ–¼ï¸</span>
            <span class="density-label">Full</span>
          </button>
        </div>
      </div>

      <!-- Sounds Section -->
      <div class="settings-section" id="section-sounds">
        <h5 class="settings-section-title">ğŸ”” Sounds</h5>
        <div class="notif-settings">
          <label class="toggle-row">
            <span>Notifications</span>
            <input type="checkbox" id="notif-enabled" checked>
          </label>
          <label class="volume-row">
            <span>Volume</span>
            <input type="range" id="notif-volume" min="0" max="100" value="50" class="slider-sm">
          </label>
          <label class="select-row">
            <span>Messages</span>
            <select id="notif-msg-sound">
              <option value="ping">Ping</option>
              <option value="chime">Chime</option>
              <option value="blip">Blip</option>
              <option value="bell">Bell</option>
              <option value="drop">Drop</option>
              <option value="alert">Alert</option>
              <option value="chord">Chord</option>
              <option value="none">None</option>
            </select>
          </label>
          <div class="notif-divider"></div>
          <label class="volume-row">
            <span>@Mention Vol</span>
            <input type="range" id="notif-mention-volume" min="0" max="100" value="80" class="slider-sm">
          </label>
          <label class="select-row">
            <span>@Mentions</span>
            <select id="notif-mention-sound">
              <option value="bell">Bell</option>
              <option value="alert">Alert</option>
              <option value="chord">Chord</option>
              <option value="ping">Ping</option>
              <option value="chime">Chime</option>
              <option value="blip">Blip</option>
              <option value="drop">Drop</option>
              <option value="none">None</option>
            </select>
          </label>
          <div class="notif-divider"></div>
          <label class="select-row">
            <span>User Joined</span>
            <select id="notif-join-sound">
              <option value="chime">Chime</option>
              <option value="bell">Bell</option>
              <option value="ping">Ping</option>
              <option value="blip">Blip</option>
              <option value="chord">Chord</option>
              <option value="none">None</option>
            </select>
          </label>
          <label class="select-row">
            <span>User Left</span>
            <select id="notif-leave-sound">
              <option value="drop">Drop</option>
              <option value="chime">Chime</option>
              <option value="ping">Ping</option>
              <option value="blip">Blip</option>
              <option value="none">None</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Push Notifications Section -->
      <div class="settings-section" id="section-push">
        <h5 class="settings-section-title">ğŸ“² Push Notifications</h5>
        <div class="notif-settings">
          <label class="toggle-row">
            <span>Enable Push</span>
            <input type="checkbox" id="push-notif-enabled">
          </label>
          <small class="settings-hint" id="push-notif-status">Checking...</small>
          <small class="settings-hint" style="opacity:0.5">Receive notifications even when Haven is closed</small>
        </div>
      </div>

      <!-- Password Change Section -->
      <div class="settings-section" id="section-password">
        <h5 class="settings-section-title">ğŸ”’ Password</h5>
        <div class="password-change-form">
          <div class="form-group compact">
            <input type="password" id="current-password" placeholder="Current password" maxlength="128" autocomplete="current-password">
          </div>
          <div class="form-group compact">
            <input type="password" id="new-password" placeholder="New password (8+ chars)" maxlength="128" autocomplete="new-password">
          </div>
          <div class="form-group compact">
            <input type="password" id="confirm-password" placeholder="Confirm new password" maxlength="128" autocomplete="new-password">
          </div>
          <button class="btn-sm btn-full" id="change-password-btn">Change Password</button>
          <small class="settings-hint" id="password-status"></small>
        </div>
      </div>

      <!-- Admin Section (hidden for non-admins) -->
      <div class="settings-section admin-settings-section" id="admin-mod-panel" style="display:none">
        <h5 class="settings-section-title">ğŸ›¡ï¸ Admin</h5>

        <!-- Server Branding -->
        <div class="admin-settings" id="section-branding">
          <h5 class="settings-section-subtitle">ğŸ  Server Branding</h5>
          <label class="select-row">
            <span>Server Name</span>
            <input type="text" id="server-name-input" maxlength="32" class="settings-text-input" style="max-width:160px" placeholder="HAVEN">
          </label>
          <div class="server-icon-upload-area">
            <div class="server-icon-preview" id="server-icon-preview">
              <span class="server-icon-text">â¬¡</span>
            </div>
            <div class="server-icon-upload-controls">
              <small class="settings-hint">Server icon (square, max 2 MB)</small>
              <input type="file" id="server-icon-file" accept="image/*" style="font-size:11px;max-width:160px">
              <div style="display:flex;gap:4px;margin-top:4px">
                <button class="btn-sm btn-accent" id="server-icon-upload-btn">Upload</button>
                <button class="btn-sm" id="server-icon-remove-btn">Remove</button>
              </div>
            </div>
          </div>
        </div>

        <div class="admin-settings" id="section-members" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
          <label class="select-row">
            <span>Show Members</span>
            <select id="member-visibility-select">
              <option value="online">Online Only</option>
              <option value="all">All Members</option>
              <option value="none">Hidden</option>
            </select>
          </label>
          <button class="btn-sm btn-full" id="view-bans-btn">ğŸ“‹ View Bans</button>
        </div>
        <div class="admin-settings" id="section-whitelist" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
          <h5 class="settings-section-subtitle">ğŸ›¡ï¸ Whitelist</h5>
          <label class="toggle-row">
            <span>Enabled</span>
            <input type="checkbox" id="whitelist-enabled">
          </label>
          <small class="settings-hint">When enabled, only pre-approved usernames can register</small>
          <div id="whitelist-panel" style="margin-top:8px;">
            <div class="whitelist-add-row">
              <input type="text" id="whitelist-username-input" placeholder="Username..." maxlength="20" class="settings-text-input">
              <button class="btn-sm btn-accent" id="whitelist-add-btn">Add</button>
            </div>
            <div id="whitelist-list" class="whitelist-list">
              <p class="muted-text">Loading...</p>
            </div>
          </div>
        </div>
        <div class="admin-settings" id="section-invite" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
          <h5 class="settings-section-subtitle">ğŸŒ Server Invite Code</h5>
          <small class="settings-hint">A single code that adds people to every channel &amp; sub-channel on the server</small>
          <div style="margin-top:8px;">
            <div id="server-code-display" style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
              <code id="server-code-value" style="font-family:monospace;font-size:1rem;letter-spacing:0.05em;opacity:0.7">â€”</code>
              <button class="btn-sm" id="copy-server-code-btn" title="Copy code">ğŸ“‹</button>
            </div>
            <div style="display:flex;gap:4px;">
              <button class="btn-sm btn-accent" id="generate-server-code-btn">Generate</button>
              <button class="btn-sm" id="clear-server-code-btn">Clear</button>
            </div>
          </div>
        </div>
        <div class="admin-settings" id="section-cleanup" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
          <h5 class="settings-section-subtitle">ğŸ—‘ï¸ Auto-Cleanup</h5>
          <label class="toggle-row">
            <span>Enabled</span>
            <input type="checkbox" id="cleanup-enabled">
          </label>
          <label class="select-row">
            <span>Max Age (days)</span>
            <input type="number" id="cleanup-max-age" min="0" max="3650" value="0" class="settings-number-input">
          </label>
          <small class="settings-hint">Delete messages older than N days (0 = off)</small>
          <label class="select-row">
            <span>Max DB Size (MB)</span>
            <input type="number" id="cleanup-max-size" min="0" max="100000" value="0" class="settings-number-input">
          </label>
          <small class="settings-hint">Trim oldest messages when DB exceeds N MB (0 = off)</small>
          <button class="btn-sm btn-full" id="run-cleanup-now-btn" style="margin-top:4px;">ğŸ§¹ Run Cleanup Now</button>
        </div>
        <div class="admin-settings" id="section-uploads" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
          <h5 class="settings-section-subtitle">ğŸ“ File Uploads</h5>
          <label class="select-row">
            <span>Max Upload Size (MB)</span>
            <input type="number" id="max-upload-mb" min="1" max="2048" value="25" class="settings-number-input">
          </label>
          <small class="settings-hint">Maximum file size users can upload (1â€“2048 MB / 2 GB, default 25)</small>
        </div>
        <div class="admin-settings" id="section-sounds-admin" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
          <h5 class="settings-section-subtitle">ğŸ”Š Custom Sounds</h5>
          <small class="settings-hint">Upload audio files for custom notification sounds</small>
          <div style="margin-top:8px;">
            <button class="btn-sm btn-full btn-accent" id="open-sound-manager-btn">âš™ï¸ Manage Sounds</button>
          </div>
        </div>
        <div class="admin-settings" id="section-emojis" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
          <h5 class="settings-section-subtitle">ğŸ˜ Custom Emojis</h5>
          <small class="settings-hint">Upload images for custom server emojis</small>
          <div style="margin-top:8px;">
            <button class="btn-sm btn-full btn-accent" id="open-emoji-manager-btn">âš™ï¸ Manage Emojis</button>
          </div>
        </div>
        <!-- Role Management (Admin only) -->
        <div class="admin-settings" id="section-roles" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
          <h5 class="settings-section-subtitle">ğŸ‘‘ Role Management</h5>
          <small class="settings-hint">Create and manage roles. Assign roles to users from the user list context menu.</small>
          <div style="margin-top:8px;">
            <button class="btn-sm btn-full btn-accent" id="open-role-editor-btn">âš™ï¸ Manage Roles</button>
          </div>
          <div id="roles-list-preview" style="margin-top:8px;">
            <p class="muted-text">Loading roles...</p>
          </div>
        </div>
        <!-- Tunnel settings (Admin only) -->
        <div class="admin-settings" id="section-tunnel" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
          <h5 class="settings-section-subtitle">ğŸ§­ Tunnel</h5>
          <label class="select-row">
            <span>Provider</span>
            <select id="tunnel-provider-select">
              <option value="localtunnel">LocalTunnel</option>
              <option value="cloudflared">Cloudflared</option>
            </select>
          </label>
          <div style="margin-top:8px;display:flex;align-items:center;gap:8px;">
            <button class="btn-sm btn-accent" id="tunnel-toggle-btn">Start Tunnel</button>
            <span id="tunnel-status-display" class="muted-text" style="font-size:11px;">Inactive</span>
          </div>
        </div>
        <!-- Webhooks / Bots (Admin only) -->
        <div class="admin-settings" id="section-bots" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
          <h5 class="settings-section-subtitle">ğŸ¤– Webhooks / Bots</h5>
          <small class="settings-hint">Create and manage webhook bots that can post messages to channels.</small>
          <div style="margin-top:8px;">
            <button class="btn-sm btn-full btn-accent" id="open-bot-editor-btn">âš™ï¸ Manage Bots</button>
          </div>
          <div id="webhooks-list" style="margin-top:8px;">
            <p class="muted-text">No bots configured</p>
          </div>
        </div>
        <!-- Discord Import (Admin only) -->
        <div class="admin-settings" id="section-import" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
          <h5 class="settings-section-subtitle">ğŸ“¦ Discord Import</h5>
          <small class="settings-hint">Import channels and messages from a Discord export file</small>
          <div style="margin-top:8px;">
            <button class="btn-sm btn-full btn-accent" id="open-import-btn">ğŸ“¦ Import from Discord</button>
          </div>
        </div>
        <!-- Mod Mode (Admin only) -->
        <div class="admin-settings" id="section-modmode" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border);">
          <h5 class="settings-section-subtitle">ğŸ”§ Mod Mode</h5>
          <small class="settings-hint">Rearrange sidebar sections and snap server/sidebar/status panels</small>
          <button class="btn-sm btn-full" id="mod-mode-settings-toggle" style="margin-top:6px;">ğŸ”§ Toggle Mod Mode</button>
          <button class="btn-sm btn-full" id="mod-mode-reset" style="margin-top:6px;">â†º Reset Layout</button>
        </div>
        <!-- Admin save bar â€” changes only apply when Save is clicked -->
        <div class="admin-save-bar">
          <button class="btn-accent btn-admin-save" id="admin-save-btn">ğŸ’¾ Save Settings</button>
          <small class="settings-hint" style="text-align:center;margin-top:4px">Changes only apply when you click Save. Close (âœ•) to cancel.</small>
        </div>
      </div>
        </div><!-- /settings-body -->
      </div><!-- /settings-layout -->
    </div>
  </div>

  <!-- Discord Import Modal -->
  <div class="modal-overlay" id="import-modal" style="display:none">
    <div class="modal" style="max-width:560px">
      <h3>ğŸ“¦ Import from Discord</h3>

      <!-- Step 1: Upload or Connect -->
      <div id="import-step-upload">
        <div class="import-tabs">
          <button class="import-tab active" data-tab="file">ğŸ“ Upload File</button>
          <button class="import-tab" data-tab="connect">ğŸ”— Connect to Discord</button>
        </div>

        <!-- Tab: Upload File -->
        <div id="import-tab-file">
          <p class="settings-hint" style="margin-bottom:10px">
            Upload a Discord export file to import channels and messages into Haven.
          </p>
          <div class="import-format-info">
            <div class="import-format-row">
              <strong>DiscordChatExporter</strong>
              <span class="muted-text">â€” JSON or ZIP (recommended â€” includes all users)</span>
            </div>
            <div class="import-format-row">
              <strong>Discord Data Package</strong>
              <span class="muted-text">â€” ZIP from Settings â†’ Privacy (your messages only)</span>
            </div>
          </div>
          <div class="import-dropzone" id="import-dropzone">
            <input type="file" id="import-file-input" accept=".json,.zip" style="display:none">
            <div class="import-dropzone-content">
              <span class="import-dropzone-icon">ğŸ“</span>
              <span>Drop file here or <a href="#" id="import-browse-link">browse</a></span>
              <span class="muted-text" style="font-size:11px">.json or .zip â€” up to 500 MB</span>
            </div>
          </div>
          <div id="import-upload-progress" style="display:none">
            <div class="import-progress-bar"><div class="import-progress-fill" id="import-progress-fill"></div></div>
            <p class="muted-text" id="import-upload-status" style="margin-top:6px;text-align:center">Uploading...</p>
          </div>
        </div>

        <!-- Tab: Connect to Discord -->
        <div id="import-tab-connect" style="display:none">
          <div id="import-connect-step-token">
            <p class="settings-hint" style="margin-bottom:8px">
              Connect directly to Discord and pull your messages â€” no external tools needed.
            </p>
            <details class="import-token-help">
              <summary>How do I get my Discord token?</summary>
              <div class="import-token-steps">
                <ol>
                  <li>Open <a href="https://discord.com/app" target="_blank" rel="noopener">discord.com/app</a> in Chrome/Edge (or use the desktop app)</li>
                  <li>Press <kbd>F12</kbd> to open DevTools</li>
                  <li>Click the <strong>Application</strong> tab (click <code>&gt;&gt;</code> in the toolbar if you don't see it)</li>
                  <li>In the left sidebar, expand <strong>Local Storage</strong> â†’ click <strong>https://discord.com</strong></li>
                  <li>Find the <code>token</code> key â€” copy the value (without the quotes)</li>
                </ol>
                <p style="margin-top:8px"><strong>Desktop app:</strong> If F12 doesn't open DevTools, close Discord fully, then edit:</p>
                <code class="import-token-snippet">%appdata%\discord\settings.json</code>
                <p style="margin-top:4px">Add this line anywhere inside the { }:</p>
                <code class="import-token-snippet">"DANGEROUS_ENABLE_DEVTOOLS_ONLY_ENABLE_IF_YOU_KNOW_WHAT_YOURE_DOING": true</code>
                <p style="margin-top:4px">Restart Discord, then follow the steps above.</p>
                <p class="muted-text" style="margin-top:8px">âš ï¸ Your token is like a password. Haven uses it only for this import and never stores it.</p>
              </div>
            </details>
            <div style="display:flex;gap:8px;margin-top:10px">
              <input type="password" id="import-discord-token" class="import-token-input" placeholder="Paste your Discord token here">
              <button class="btn-sm btn-accent" id="import-connect-btn">Connect</button>
            </div>
            <p class="muted-text" id="import-connect-status" style="margin-top:6px;display:none"></p>
          </div>

          <div id="import-connect-step-servers" style="display:none">
            <div class="import-info-bar" style="margin-bottom:8px">
              <span>Connected as <strong id="import-discord-username"></strong></span>
              <a href="#" id="import-connect-disconnect" style="font-size:11px;margin-left:auto">Disconnect</a>
            </div>
            <p class="settings-hint" style="margin-bottom:6px">Pick a server to import from:</p>
            <div id="import-server-list" class="import-server-grid"></div>
          </div>

          <div id="import-connect-step-channels" style="display:none">
            <div class="import-info-bar" style="margin-bottom:8px">
              <span id="import-connect-guild-name" style="font-weight:600"></span>
              <a href="#" id="import-connect-back-servers" style="font-size:11px;margin-left:auto">â† Back to servers</a>
            </div>
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
              <p class="settings-hint" style="margin:0;flex:1">Select channels to fetch:</p>
              <a href="#" id="import-connect-toggle-all" style="font-size:11px;white-space:nowrap">Deselect All</a>
            </div>
            <div class="import-channel-list" id="import-connect-channel-list"></div>
            <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
              <button class="btn-sm btn-accent" id="import-fetch-btn">ğŸ“¥ Fetch Messages</button>
            </div>
            <p class="muted-text" id="import-fetch-status" style="margin-top:6px;display:none"></p>
          </div>
        </div>
      </div>

      <!-- Step 2: Preview & Select -->
      <div id="import-step-preview" style="display:none">
        <div class="import-info-bar">
          <span class="import-format-badge" id="import-format-badge"></span>
          <span id="import-server-name" style="font-weight:600"></span>
          <span class="muted-text" id="import-total-msgs"></span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin:8px 0 6px">
          <p class="settings-hint" style="margin:0;flex:1">Select channels to import. You can rename them before importing.</p>
          <a href="#" id="import-toggle-all" style="font-size:11px;white-space:nowrap">Deselect All</a>
        </div>
        <div class="import-channel-list" id="import-channel-list"></div>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <button class="btn-sm" id="import-back-btn">â† Back</button>
          <button class="btn-sm btn-accent" id="import-execute-btn">ğŸ“¦ Import Selected</button>
        </div>
      </div>

      <!-- Step 3: Done -->
      <div id="import-step-done" style="display:none;text-align:center;padding:20px 0">
        <div style="font-size:48px;margin-bottom:12px">âœ…</div>
        <p id="import-done-msg" style="font-size:14px">Import complete!</p>
      </div>

      <div class="modal-actions" style="margin-top:12px">
        <button class="btn-sm" id="close-import-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Role Management Modal -->
  <div class="modal-overlay" id="role-modal" style="display:none">
    <div class="modal modal-wide">
      <h3>ğŸ‘‘ Role Management</h3>
      <div class="role-editor-layout">
        <div class="role-sidebar">
          <div id="role-list-sidebar" class="role-list-sidebar"></div>
          <button class="btn-sm btn-accent btn-full" id="create-role-btn" style="margin-top:8px;">+ New Role</button>
        </div>
        <div class="role-detail" id="role-detail-panel">
          <p class="muted-text" style="padding:20px;text-align:center">Select a role to edit</p>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-sm" id="close-role-modal-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Assign Role Modal -->
  <div class="modal-overlay" id="assign-role-modal" style="display:none">
    <div class="modal" style="max-width:440px">
      <h3>ğŸ‘‘ Assign Role</h3>
      <p id="assign-role-user-label" class="muted-text"></p>

      <label class="assign-role-field-label">Role</label>
      <select id="assign-role-select" class="settings-select assign-role-select">
        <option value="">-- Select Role --</option>
      </select>

      <label class="assign-role-field-label" style="margin-top:10px">Scope</label>
      <p class="assign-role-hint">Server-wide applies to all channels. Channel-specific only applies within that channel.</p>
      <select id="assign-role-scope" class="settings-select assign-role-select">
        <option value="server">ğŸŒ Server-wide</option>
      </select>

      <div class="modal-actions">
        <button class="btn-sm" id="cancel-assign-role-btn">Cancel</button>
        <button class="btn-sm btn-accent" id="confirm-assign-role-btn">Assign</button>
      </div>
    </div>
  </div>
  <!-- Bot Management Modal -->
  <div class="modal-overlay" id="bot-modal" style="display:none">
    <div class="modal modal-wide">
      <h3>ğŸ¤– Bot Management</h3>
      <div class="role-editor-layout">
        <div class="role-sidebar">
          <div id="bot-list-sidebar" class="role-list-sidebar"></div>
          <button class="btn-sm btn-accent btn-full" id="create-bot-btn" style="margin-top:8px;">+ New Bot</button>
        </div>
        <div class="role-detail" id="bot-detail-panel">
          <p class="muted-text" style="padding:20px;text-align:center">Select a bot to edit, or create a new one</p>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-sm" id="close-bot-modal-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Sound Management Modal -->
  <div class="modal-overlay" id="sound-modal" style="display:none">
    <div class="modal" style="max-width:520px">
      <h3>ğŸ”Š Sound Management</h3>
      <small class="settings-hint" style="display:block;margin-bottom:12px">Upload audio files for custom notification sounds (max 1 MB each)</small>
      <div class="whitelist-add-row">
        <input type="text" id="sound-name-input" placeholder="Sound name..." maxlength="30" class="settings-text-input">
        <input type="file" id="sound-file-input" accept="audio/*" style="max-width:120px;font-size:11px">
        <button class="btn-sm btn-accent" id="sound-upload-btn">Upload</button>
      </div>
      <div id="custom-sounds-list" style="margin-top:12px;">
        <p class="muted-text">No custom sounds uploaded</p>
      </div>
      <div class="modal-actions">
        <button class="btn-sm" id="close-sound-modal-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Emoji Management Modal -->
  <div class="modal-overlay" id="emoji-modal" style="display:none">
    <div class="modal" style="max-width:520px">
      <h3>ğŸ˜ Emoji Management</h3>
      <small class="settings-hint" style="display:block;margin-bottom:12px">Upload images for custom server emojis (max 256 KB, png/gif/webp). Name must be lowercase, no spaces.</small>
      <div class="whitelist-add-row">
        <input type="text" id="emoji-name-input" placeholder="emoji_name" maxlength="30" class="settings-text-input">
        <input type="file" id="emoji-file-input" accept="image/png,image/gif,image/webp,image/jpeg" style="max-width:120px;font-size:11px">
        <button class="btn-sm btn-accent" id="emoji-upload-btn">Upload</button>
      </div>
      <div id="custom-emojis-list" style="margin-top:12px;">
        <p class="muted-text">No custom emojis uploaded</p>
      </div>
      <div class="modal-actions">
        <button class="btn-sm" id="close-emoji-modal-btn">Close</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="bans-modal" style="display:none">
    <div class="modal modal-wide">
      <h3>Banned Users</h3>
      <div id="bans-list" class="bans-list">
        <p class="muted-text">Loading...</p>
      </div>
      <div class="modal-actions">
        <button class="btn-sm" id="close-bans-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Music Share Modal -->
  <div class="modal-overlay" id="music-modal" style="display:none">
    <div class="modal">
      <h3>ğŸµ Listen Together</h3>
      <p class="modal-desc">Paste a link from Spotify, YouTube, or SoundCloud to share with everyone in voice</p>
      <div class="form-group">
        <label>Music Link</label>
        <input type="text" id="music-link-input" placeholder="https://open.spotify.com/track/..." maxlength="500">
      </div>
      <div class="music-link-preview" id="music-link-preview"></div>
      <div class="music-platforms-hint">
        <span class="platform-badge spotify">Spotify</span>
        <span class="platform-badge youtube">YouTube</span>
        <span class="platform-badge soundcloud">SoundCloud</span>
      </div>
      <div class="modal-actions">
        <button class="btn-sm" id="cancel-music-btn">Cancel</button>
        <button class="btn-sm btn-accent" id="share-music-btn">Share with Channel</button>
      </div>
    </div>
  </div>

  <!-- Manage Servers Modal -->
  <div class="modal-overlay" id="manage-servers-modal" style="display:none">
    <div class="modal" style="max-width:480px">
      <h3>âš™ Manage Servers</h3>
      <p class="modal-desc">Edit or remove your linked servers</p>
      <div id="manage-servers-list" class="manage-servers-list"></div>
      <div class="modal-actions" style="justify-content:space-between">
        <button class="btn-sm btn-accent" id="manage-servers-add-btn">+ Add Server</button>
        <button class="btn-sm" id="manage-servers-close-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Channel context menu (appears on "..." hover button) -->
  <div id="channel-ctx-menu" class="channel-ctx-menu" style="display:none">
    <button class="channel-ctx-item" data-action="mute">ğŸ”” Mute Channel</button>
    <button class="channel-ctx-item" data-action="join-voice">ğŸ™ï¸ Join Voice</button>
    <button class="channel-ctx-item" data-action="leave-voice" style="display:none">ğŸ“´ Disconnect Voice</button>
    <hr class="channel-ctx-sep">
    <button class="channel-ctx-item mod-only" data-action="rename-channel">âœï¸ Rename Channel</button>
    <button class="channel-ctx-item mod-only" data-action="create-sub-channel">ğŸ“ Create Sub-channel</button>
    <hr class="channel-ctx-sep admin-only">
    <button class="channel-ctx-item admin-only" data-action="organize" style="display:none">ğŸ“‹ Organize</button>
    <button class="channel-ctx-item admin-only" data-action="toggle-streams">ğŸ–¥ï¸ Toggle Streams</button>
    <button class="channel-ctx-item admin-only" data-action="toggle-music">ğŸµ Toggle Music</button>
    <button class="channel-ctx-item admin-only" data-action="slow-mode">ğŸ¢ Slow Mode</button>
    <button class="channel-ctx-item admin-only" data-action="channel-roles">ğŸ‘‘ Roles</button>
    <button class="channel-ctx-item admin-only" data-action="webhooks">ğŸ¤– Webhooks</button>
    <hr class="channel-ctx-sep admin-only">
    <button class="channel-ctx-item admin-only danger" data-action="delete">ğŸ—‘ï¸ Delete Channel</button>
  </div>

  <!-- DM context menu -->
  <div id="dm-ctx-menu" class="channel-ctx-menu" style="display:none">
    <button class="channel-ctx-item" data-action="dm-mute">ğŸ”” Mute DM</button>
    <hr class="channel-ctx-sep">
    <button class="channel-ctx-item danger" data-action="dm-delete">ğŸ—‘ï¸ Delete DM</button>
  </div>

  <!-- Organize Sub-channels Modal -->
  <div class="modal-overlay" id="organize-modal" style="display:none">
    <div class="modal" style="max-width:500px">
      <h3 id="organize-modal-title">ğŸ“‹ Organize</h3>
      <p class="modal-desc" id="organize-modal-parent-name"></p>

      <div class="organize-toolbar">
        <label class="organize-toolbar-label">Sort:</label>
        <select id="organize-global-sort" class="organize-select">
          <option value="manual">Manual</option>
          <option value="alpha">Alphabetical</option>
          <option value="created">Newest First</option>
          <option value="oldest">Oldest First</option>
        </select>
      </div>

      <div class="organize-toolbar" id="organize-cat-toolbar" style="display:none">
        <label class="organize-toolbar-label">Categories:</label>
        <select id="organize-cat-sort" class="organize-select">
          <option value="manual">Manual Order</option>
          <option value="az">A â†’ Z</option>
          <option value="za">Z â†’ A</option>
        </select>
      </div>

      <div id="organize-channel-list" class="organize-list"></div>

      <div class="organize-controls">
        <button class="btn-sm" id="organize-move-up" title="Move selected channel up">â¬† Up</button>
        <button class="btn-sm" id="organize-move-down" title="Move selected channel down">â¬‡ Down</button>
        <div class="organize-spacer"></div>
        <div class="organize-tag-group">
          <input type="text" id="organize-tag-input" class="organize-tag-input" maxlength="30" placeholder="Tag nameâ€¦">
          <button class="btn-sm organize-tag-btn" id="organize-set-tag" title="Apply tag">ğŸ·ï¸ Set</button>
          <button class="btn-sm organize-tag-btn danger" id="organize-remove-tag" title="Remove tag">âœ•</button>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn-sm btn-accent" id="organize-done-btn">Done</button>
      </div>
    </div>
  </div>

  <!-- DM Organize Modal -->
  <div class="modal-overlay" id="dm-organize-modal" style="display:none">
    <div class="modal" style="max-width:460px">
      <h3>ğŸ“‹ Organize DMs</h3>
      <p class="modal-desc">Tag your conversations into collapsible categories</p>

      <div class="organize-toolbar">
        <label class="organize-toolbar-label">Sort:</label>
        <select id="dm-organize-sort" class="organize-select">
          <option value="manual">Manual</option>
          <option value="alpha">Alphabetical</option>
          <option value="recent">Recent Activity</option>
        </select>
      </div>

      <div id="dm-organize-list" class="organize-list"></div>

      <div class="organize-controls">
        <button class="btn-sm" id="dm-organize-move-up" title="Move up">â¬† Up</button>
        <button class="btn-sm" id="dm-organize-move-down" title="Move down">â¬‡ Down</button>
        <div class="organize-spacer"></div>
        <div class="organize-tag-group">
          <input type="text" id="dm-organize-tag-input" class="organize-tag-input" maxlength="30" placeholder="Categoryâ€¦">
          <button class="btn-sm organize-tag-btn" id="dm-organize-set-tag" title="Apply category">ğŸ·ï¸ Set</button>
          <button class="btn-sm organize-tag-btn danger" id="dm-organize-remove-tag" title="Remove category">âœ•</button>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn-sm btn-accent" id="dm-organize-done-btn">Done</button>
      </div>
    </div>
  </div>

  <!-- Webhook Management Modal -->

  <!-- Channel Roles Modal -->
  <div class="modal-overlay" id="channel-roles-modal" style="display:none">
    <div class="modal modal-wide">
      <h3>ğŸ‘‘ Channel Roles</h3>
      <p class="modal-desc" id="channel-roles-channel-name"></p>

      <div class="channel-roles-layout">
        <!-- Left: Members + Assignment -->
        <div class="channel-roles-left">
          <h4 class="channel-roles-section-title">Members</h4>
          <div class="channel-roles-member-list" id="channel-roles-member-list"></div>

          <div class="channel-roles-actions" id="channel-roles-actions" style="display:none">
            <h4 class="channel-roles-selected-name" id="channel-roles-selected-name"></h4>
            <div class="channel-roles-current" id="channel-roles-current-roles"></div>
            <div class="channel-roles-assign-area">
              <div class="channel-roles-assign-row">
                <select id="channel-roles-role-select" class="organize-select">
                  <option value="">-- Select Role --</option>
                </select>
                <select id="channel-roles-scope-select" class="organize-select" style="max-width:140px">
                  <option value="server">ğŸŒ Server-wide</option>
                  <option value="channel">ğŸ“Œ This Channel</option>
                </select>
                <button class="btn-sm btn-accent" id="channel-roles-assign-btn">Assign</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Role Configuration -->
        <div class="channel-roles-right">
          <h4 class="channel-roles-section-title">Role Configuration</h4>
          <div class="channel-roles-role-list" id="channel-roles-role-list"></div>
          <button class="btn-sm btn-accent btn-full" id="channel-roles-create-btn" style="margin-top:6px">+ New Role</button>
          <div class="channel-roles-role-detail" id="channel-roles-role-detail">
            <p class="muted-text" style="padding:12px;text-align:center;font-size:0.82rem">Select a role to configure</p>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn-sm btn-accent" id="channel-roles-done-btn">Done</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="webhook-modal" style="display:none">
    <div class="modal" style="max-width:520px">
      <h3>ğŸ¤– Webhooks</h3>
      <p class="modal-desc" id="webhook-modal-channel-name"></p>

      <!-- Create new webhook -->
      <div class="form-group" style="display:flex;gap:8px;align-items:flex-end">
        <div style="flex:1">
          <label>New Webhook Name</label>
          <input type="text" id="webhook-name-input" class="input" maxlength="32" placeholder="My Bot" style="width:100%">
        </div>
        <button class="btn-sm btn-accent" id="webhook-create-btn" style="height:36px">Create</button>
      </div>

      <!-- Webhook list -->
      <div id="webhook-list" style="margin-top:14px;max-height:280px;overflow-y:auto"></div>

      <!-- Token reveal (shown once after creation) -->
      <div id="webhook-token-reveal" style="display:none;margin-top:14px;padding:12px;border-radius:8px;background:rgba(0,0,0,0.25);border:1px solid var(--accent-color, #00e5ff)">
        <p style="font-size:0.85rem;margin:0 0 8px;opacity:0.7">âš ï¸ Copy this URL now â€” you won't see the full token again!</p>
        <div style="display:flex;gap:6px">
          <input type="text" id="webhook-url-display" class="input" readonly style="flex:1;font-size:0.8rem;font-family:monospace">
          <button class="btn-sm" id="webhook-copy-url-btn">ğŸ“‹ Copy</button>
        </div>
      </div>

      <div class="modal-actions" style="margin-top:16px">
        <button class="btn-sm" id="webhook-close-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Create Sub-channel Modal -->
  <div class="modal-overlay" id="create-sub-modal" style="display:none">
    <div class="modal-box" style="max-width:380px">
      <h3>Create Sub-channel</h3>
      <p class="modal-desc" id="create-sub-parent-name"></p>
      <label style="display:block;margin:12px 0 6px;font-size:0.85rem;opacity:0.7">Sub-channel name</label>
      <input type="text" id="create-sub-name" class="input" maxlength="50" placeholder="sub-channel name..." style="width:100%">
      <label class="checkbox-row" style="margin:14px 0 8px;display:flex;align-items:center;gap:8px;cursor:pointer">
        <input type="checkbox" id="create-sub-private" style="width:16px;height:16px">
        <span style="font-size:0.9rem">ğŸ”’ Private <span style="opacity:0.5;font-size:0.8rem">(invite-only, hidden from non-members)</span></span>
      </label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
        <button class="btn-sm" id="create-sub-cancel-btn">Cancel</button>
        <button class="btn-sm btn-accent" id="create-sub-confirm-btn">Create</button>
      </div>
    </div>
  </div>

  <!-- Stackable effect overlay container -->
  <div id="fx-layers"></div>

  <!-- Push Notification Error Modal (center-screen, requires acknowledgement) -->
  <!-- Activities / Games Launcher Modal -->
  <div class="modal-overlay" id="activities-modal" style="display:none">
    <div class="modal modal-activities">
      <div class="activities-header">
        <h3>ğŸ® Activities</h3>
        <button class="settings-close-btn" id="close-activities-btn">&times;</button>
      </div>
      <div class="activities-grid" id="activities-grid">
        <!-- Populated dynamically by JS from GAMES_REGISTRY -->
      </div>
    </div>
  </div>

  <!-- Iframe Game Container (fullscreen overlay) -->
  <div class="game-iframe-overlay" id="game-iframe-overlay" style="display:none">
    <div class="game-iframe-header">
      <span class="game-iframe-title" id="game-iframe-title">Game</span>
      <div class="game-iframe-actions">
        <label style="display:flex;align-items:center;gap:6px;color:var(--text-secondary);font-size:12px;margin-right:8px;" title="Game Volume">
          ğŸ”Š <input type="range" id="game-volume-slider" min="0" max="100" value="80" style="width:80px;accent-color:var(--accent);">
          <span id="game-volume-pct" style="min-width:28px;font-size:11px;">80%</span>
        </label>
        <button class="btn-sm" id="game-iframe-popout" title="Open in new window">â†—ï¸ Pop Out</button>
        <button class="btn-sm btn-danger" id="game-iframe-close" title="Close game">&times; Close</button>
      </div>
    </div>
    <iframe id="game-iframe" class="game-iframe" sandbox="allow-scripts allow-same-origin allow-popups allow-forms" allowfullscreen></iframe>
  </div>

  <div class="modal-overlay" id="push-error-modal" style="display:none">
    <div class="modal" style="max-width:420px;text-align:center;padding:28px 24px;">
      <div style="font-size:48px;margin-bottom:12px;">ğŸ”•</div>
      <h3 style="margin:0 0 12px;color:var(--text-primary)">Push Notifications Unavailable</h3>
      <p id="push-error-reason" style="color:var(--text-secondary);font-size:14px;line-height:1.5;margin:0 0 16px;"></p>
      <p style="color:var(--text-muted);font-size:12px;line-height:1.5;margin:0 0 20px;">
        <strong>Recommended:</strong> Google Chrome, Microsoft Edge, or Opera on desktop.<br>
        iOS requires Safari 16.4+ with Haven added to your Home Screen.
      </p>
      <button class="btn-accent" id="push-error-dismiss-btn" style="width:100%;padding:10px;font-size:14px;font-weight:600;">Got It</button>
    </div>
  </div>

  <!-- E2E Password Prompt Modal -->
  <div id="e2e-password-modal" class="modal-overlay" style="display:none">
    <div class="modal e2e-password-modal">
      <h3>ğŸ” Password Required</h3>
      <p class="e2e-pw-desc">End-to-end encryption requires your password to unlock your keys. Enter your account password to continue.</p>
      <div class="e2e-pw-field">
        <input type="password" id="e2e-pw-input" placeholder="Enter your password" autocomplete="current-password" spellcheck="false">
      </div>
      <div id="e2e-pw-error" class="e2e-pw-error" style="display:none"></div>
      <div class="e2e-pw-actions">
        <button class="btn-accent" id="e2e-pw-submit-btn">Unlock</button>
        <button class="btn-sm" id="e2e-pw-cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>

  <!-- Image Lightbox Overlay -->
  <div id="image-lightbox" class="image-lightbox" style="display:none">
    <img id="lightbox-img" class="lightbox-img" src="" alt="">
  </div>
  <script src="/js/theme.js?v=1.8.0"></script>
  <script src="/js/notifications.js?v=1.8.0"></script>
  <script src="/js/servers.js?v=1.8.0"></script>
  <script src="/js/voice.js?v=1.8.0"></script>
  <script src="/js/modmode.js?v=1.8.0"></script>
  <script src="/js/e2e.js?v=2.1.0"></script>
  <script src="/js/app.js?v=2.1.0"></script>
</body>
</html>
